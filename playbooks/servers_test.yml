---
- name: Run on all TEST_SERVERS
  hosts: test_servers
  gather_facts: true
  become: true

  vars_files: ../group_vars/secrets.yml

  roles:
    - role: system
      tags: system
    - role: geerlingguy.security
      tags: security
    - role: geerlingguy.ntp
      tags: ntp

###
- name: Run on "dev01.test"
  hosts: dev01.test
  gather_facts: true
  become: true

  vars_files: ../group_vars/secrets.yml

  roles:
    - role: geerlingguy.pip
      tags: containers
    - role: geerlingguy.docker
      tags: containers
    - role: ufw
      tags: ufw

  tasks:
    - name: Essential-debian | Install extra packages
      ansible.builtin.package:
        name: "{{ extra_packages }}"
        state: present

###
- name: Run on "srv01.test"
  hosts: srv01.test
  gather_facts: true
  become: true

  vars_files: ../group_vars/secrets.yml

  roles:
    - role: geerlingguy.pip
      tags: containers
    - role: geerlingguy.docker
      tags: containers
    - role: ufw
      tags: ufw
    - role: dockge
      tags: dockge
    - role: littlelink
      tags:
        - containers
        - littlelink

###
- name: Run on "srv02.test"
  hosts: srv02.test
  gather_facts: true
  become: true

  vars_files: ../group_vars/secrets.yml

  roles:
    - role: geerlingguy.pip
      tags: containers
    - role: geerlingguy.docker
      tags: containers
    - role: ufw
      tags: ufw

###
- name: Run on "ubt.test"
  hosts: ubt.test
  gather_facts: true
  become: true

  vars_files: ../group_vars/secrets.yml

  roles:
    - role: geerlingguy.pip
      tags: containers
    - role: ufw
      tags: ufw

  tasks:

    - name: Install | flatpak
      tags: flatpak
      become_user: deploy
      block:
        - name: Install flatpak
          become: true
          ansible.builtin.package:
            name: flatpak
            state: present
        - name: Add repository remote
          become: true
          community.general.flatpak_remote:
            name: flathub
            state: present
            flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo
            method: system
        - name: Install multiple packages
          community.general.flatpak:
            name:
              - org.videolan.VLC        ## VLC
            # - com.google.Chrome       ## Chrome Browser
            state: present
        - name: Remove multiple packages
          community.general.flatpak:
            name:
              - im.riot.Riot            ## Element matrix client
            # - com.visualstudio.code   ## VisualStudio
            state: absent

    - name: Install | starship
      tags: starship
      become: true
      block:
        - name: Get starship install script
          ansible.builtin.get_url:
            url: https://starship.rs/install.sh
            dest: /tmp/starship_install.sh
            mode: '0755'
        - name: Install starship
          ansible.builtin.shell:
            cmd: /tmp/starship_install.sh --yes
            executable: /bin/sh
          register: my_starship
          changed_when: my_starship.rc != 0

    - name: Install | VisualStudio
      tags: vscode
      become: true
      block:
        - name: Get VisualStudio install script
          ansible.builtin.command: 'sudo curl -L -o /tmp/code.deb https://go.microsoft.com/fwlink/?LinkID=760868'
          register: my_visualstudiocurl
          changed_when: my_visualstudiocurl.rc != 0
        - name: Chmod Install deb
          ansible.builtin.command: 'sudo chmod +x /tmp/code.deb'
          register: my_visualstudiodeb
          changed_when: my_visualstudiodeb.rc != 0
        - name: Install VisualStudio
          ansible.builtin.command: 'sudo dpkg -i /tmp/code.deb'
          register: my_visualstudio
          changed_when: my_visualstudio.rc != 0

    - name: Install | Git, ssh keys to use with git
      tags: git
      become_user: deploy
      block:
        - name: User | copy ssh key to use for Git to user.
          ansible.builtin.copy:
            src: ~/.ssh/git_deploy
            dest: ~/.ssh/git_deploy
            owner: deploy
            mode: '600'
        - name: User | copy ssh key to use for Git to user.
          become_user: deploy
          ansible.builtin.copy:
            src: ~/.ssh/git_deploy.pub
            dest: ~/.ssh/git_deploy.pub
            owner: deploy
            mode: '644'
        - name: Clone a dotfiles repo with separate git directory
          become: false
          ansible.builtin.git:
            repo: git@github.com:alf149/dotfiles.git
            dest: ~/git/dotfiles
            accept_hostkey: true
            clone: true
            update: true
            remote: main
            force: true
            key_file: /home/deploy/.ssh/git_deploy
          tags:
            - dotfiles
            - git

    - name: Install | Tmux and tpm
      tags: tmux
      become_user: deploy
      block:
        - name: Install tmux
          ansible.builtin.package:
            name: tmux
            state: present
        - name: Clone a tmux tpm from github
          ansible.builtin.git:
            repo: git@github.com:tmux-plugins/tpm.git
            dest: ~/.tmux/plugins/tpm
            accept_hostkey: true
            key_file: /home/deploy/.ssh/git_deploy

    - name: Install | VPN for Work
      ## https://www.citrix.com/downloads/workspace-app/linux/workspace-app-for-linux-latest.html
      ansible.builtin.package:
        name:
          - openconnect
          - network-manager-openconnect
          - network-manager-openconnect-gnome
      tags: openconnect

    - name: Install | mscorefonts, NerdFontsSymbols, CascadiaCode
      tags: fonts
      become_user: deploy
      block:
        - name: Install Fonts
          ansible.builtin.package:
            name:
              - ttf-mscorefonts-installer
          tags: fonts
        - name: Create a directory ~/.local/share/fonts
          ansible.builtin.file:
            path: ~/.local/share/fonts
            state: directory
            mode: '0755'
        - name: Download NerdFontsSymbolsOnly.zip Fonts
          ansible.builtin.unarchive:
            src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/NerdFontsSymbolsOnly.zip
            dest: ~/.local/share/fonts
            remote_src: true
        - name: Download CascadiaCode.zip Fonts
          ansible.builtin.unarchive:
            src: https://github.com/ryanoasis/nerd-fonts/releases/download/v3.0.2/CascadiaCode.zip
            dest: ~/.local/share/fonts
            remote_src: true
        - name: Update the font cache
          ansible.builtin.command: fc-cache ~/.local/share/fonts
        - name: Update the font cache
          ansible.builtin.command: fc-cache -fv

    # Config Stow another day
    # - name: Install stow
    #   ansible.builtin.package:
    #     name: stow
    #     state: present
    #   tags: stow
    # - name: Setup Stow and Dotfiles from Git Part2
    #   become_user: deploy
    #   ansible.builtin.command:
    #     chdir: ~/git/dotfiles
    #     cmd: stow -t ~ -R */ --ignore='.*\.sh'
    #   register: my_stow
    #   changed_when: my_stow.rc != 0
    #   tags: stow
